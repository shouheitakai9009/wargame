---
trigger: always_on
---

# バトルルール

このアプリは春秋戦国時代を舞台にした AI 相手に戦う戦争シミュレーションゲームです。
マスの集合体であるマップと呼ばれる戦場に、兵を配置し軍を編成し、地形の理や兵種を活かして戦闘を行います。

## 勝利条件

敵将軍の兵力を 0 にしたら勝ち

## 戦の進み方

1. 自軍となる兵をマップの配置可能エリアに配置する
2. 軍を最低 1 体成り立てる
3. AI の敵軍が軍の配置を完了するとバトル開始

### 自ターンの行動フェーズ

4. 自ターンは**行動フェーズ**と**攻撃フェーズ**に分かれます

#### 行動フェーズ（プレイヤー操作）

- **軍の向きを変更する**（何度でも可能）
- **軍を移動する**または**軍を分割する**（1 ターンに 1 回のみ、排他的）
  - 移動は 1 ターンに 1 回のみ行えます
  - 移動と軍分割は排他です。どちらか一方を行うと、そのターンは両方とも行えなくなります
  - 軍分割を行うと、元の軍と新しく作られた軍の両方が行動済みとなります

#### 攻撃フェーズ（自動実行）

- 行動フェーズ完了後、以下の条件を**すべて満たす**敵を自動的に攻撃します
  - 敵が視界内に入っている
  - 敵が射程マス内にいる
- **攻撃対象の優先順位**
  - 射程内に複数の敵がいる場合、最も近い敵を優先的に攻撃します
  - 同距離の場合は以下の優先順位で攻撃します：将軍 > 弓兵 > 騎兵 > 歩兵 > 盾兵
- **攻撃の計算**
  - 軍が攻撃判定を行い、軍内の各兵が個別にダメージを与えます
  - 軍内の各兵が 1 ターンに 1 回ずつ攻撃を行います
- **攻撃後の状態**
  - 攻撃を行った軍は「行動済み」となり、そのターンは以下が不可能になります
    - 向き変更
    - 再移動
    - 軍分割

### 敵ターン中の迎撃

5. 敵ターン中、以下の条件で迎撃を行うことができます

- **迎撃の条件**
  - 自軍がまだ「行動済み」でない（自ターンで攻撃していない）
  - 敵軍が移動して自軍の射程マス内に入った
  - 敵が視界内に入っている
  - 敵が射程マス内にいる
- **迎撃の制限**
  - 各軍は 1 ターンに 1 回のみ迎撃可能です
  - 迎撃を行った軍は「行動済み」となります
- **相互攻撃の処理順序**
  - ① 移動側（敵）が先に攻撃を受けます（迎撃）
  - ② その後、移動側（敵）が反撃します（両方が射程内にいる場合）

### 被攻撃

6. 敵ターン中、自軍が敵の射程マス内に含まれている場合、敵から攻撃を受けます
   - 視界と射程の条件は敵側にも同様に適用されます
   - 敵ターン中は自軍に対するコンテキストメニュー操作（移動、分割、向き変更など）は行えません

### 「行動済み」状態

- 「行動済み」の軍は以下の制約を受けます
  - 向き変更不可
  - 移動不可
  - 軍分割不可
  - 迎撃不可（敵ターン中）
- 「行動済み」状態は次の自ターン開始時にリセットされます
- UI では「行動済み」の軍をグレーアウトまたは "ACTED" バッジで表示します

## 配置ルール

### 配置制約

- 自軍はマップの下部から三分の一までを配置可能エリアとする
- 最大軍数: 9 軍まで
- 最大配置数: 30 体まで配置可能
- 歩兵は何体でも配置可能
- 騎兵上限: 10 体まで
- 将軍上限: 1 体のみ
- 同じマスに複数の兵を配置することはできない

## 兵

全ての兵は以下のステータスを持ちます。
各数値は 1 以下にはなりませんが、最大数以上になることはできます。
例えば士気が上がっている場合や、地形のボーナスによって最大数を超えることがあります。

- 兵力
  - 全ての兵は最大兵力 1000 から開始し、0 になったら再起不能状態となります。
- 攻撃
  - 1~5 の整数、高い方が敵の兵力を削る力が強くなります。
- 防御
  - 1~5 の整数、高い方が敵の攻撃を防ぐ力が強くなります。
- 射程
  - 1~5 の整数、攻撃時に何マス離れた敵を攻撃できるかを表します。
- 速度
  - 1~3 の整数、1 ターンに移動できるマスの最大移動量です。

### 歩兵

すべてが普通の一番数が多い兵種

- 攻撃力: 2
- 防御力: 2
- 射程: 1
- 速度: 1

### 弓兵

弓を搭載して遠距離で敵を攻撃する兵種

- 攻撃力: 3
- 防御力: 1
- 射程: 4
- 速度: 1

### 盾兵

盾を搭載して敵を守る兵種

- 攻撃力: 1
- 防御力: 4
- 射程: 1
- 速度: 1

### 騎兵

馬を乗って敵を攻撃する兵種

- 攻撃力: 3
- 防御力: 3
- 射程: 2
- 速度: 3

### 将軍

将軍は敵を倒すために必要な兵種

- 攻撃力: 5
- 防御力: 5
- 射程: 2
- 速度: 2

## 軍

軍とは、兵の集合体を軍を呼びます。

軍が持つステータスは以下の通りです。

- 名前
  - 軍の名前です。
- 士気
  - 軍の士気です。1~3 の整数、デフォルト 1 で最低を下回らず最高を上回りません。
  - 敵軍を撃破すると士気が 1 上昇します。
  - 敵軍の向きとは異なる方向からの攻撃に成功した場合士気が 1 上昇します。
  - 士気が 1 上昇するごとに軍内の兵すべてが攻撃力と防御力が 1 上昇します。
- 向き
  - 軍の向きです。上下左右のいずれかを割り当てます。デフォルトは上

軍の行動は以下の通りです。

- 向きの変更
  - 軍が向いている方向に対して、移動できるマスの量がハイライトされ、ハイライト箇所を選択することで軍全体を移動します。
- 移動
  - 移動量の計算
    - 軍内で、ステータス効果も加味した最小の速度を探し、それを軍の速度とします。
    - 軍の速度が移動できるマスの量となります。最低は 1 です。
  - 移動不可能なマス
    - 兵がいるマスには移動できない
    - 高さレベル 1 から高さレベル 3 への移動（高さ 1 からだと高さ 2 へしか移動できない）
    - 騎兵の場合水マスに移動できない

軍が成り立つルールは以下の通りです。

- 軍は 2 つ以上の兵が存在する必要があります。
- 軍内では、兵は必ず隣り合っている必要があります。
-

## 地形

- 山レベル 3 は山レベル 2 に四方が隣り合っていなければいけない
- 山レベル 2 は山レベル 1 に四方が隣り合っていなければいけない
- 森は単体では存在できず、必ず 4 つ以上の森となる
- 水は単体では存在できず、必ず 4 つ以上の森となる

### 種類

- 草
  - 基本的な地形、特殊効果なし
- 水
  - 自分と敵が両方とも水にいる場合、2 マス以内でのみ視認可能
  - 騎兵はこのマスに進むことはできない
  - ステータス変化
    - 全兵種
      - 速さが 1 になり、攻撃、防御、射程が 2 ずつ下がる
- 森
  - 自分と敵が両方とも森にいる場合、1 マス以内でのみ視認可能
  - ステータス変化
    - 弓兵
      - 射程が 2 低下
    - 歩兵
      - 攻撃と防御が 1 上昇
    - 騎兵/将軍
      - 攻撃と防御が 1 低下、速さが 2 低下
- 山（高さレベル 1~3 まである）
  - 視界による遮蔽効果なし
  - 高さレベルが高いほど視界距離が長くなる

## 兵の視界

味方、敵両方に視界という概念が存在します。
視界内であれば敵が見える、視界外であれば敵が見えなくなります。
各兵が兵の周りを囲うように n マス分視界を持ちます。
例えば n = 3 の時、視界内は「有」、視界外は「無」として表現します。

```
無有有有有有有有無
無有有有有有有有無
無有有有有有有有無
無有有有兵有有有無
無有有有有有有有無
無有有有有有有有無
無有有有有有有有無
```

視界の計算にはマンハッタン距離を使用します（`|dx| + |dy| <= n`）。
山による遮蔽効果はなく、地形の高さに関わらず視界距離内のすべてのマスを視認できます。

### 地形ごとの視界の長さ

次は兵が配置されている地形ごとの n について説明します。

- 草 = 5
- 水 = 2
- 森 = 1
- 山（高さ 1）= 5
- 山（高さ 2）= 7
- 山（高さ 3）= 10
